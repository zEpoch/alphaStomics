# AlphaSTomics - åŒæ¨¡æ€ç©ºé—´è½¬å½•ç»„æ‰©æ•£æ¨¡å‹

<p align="center">
	<b>åŒæ—¶å¯¹åŸºå› è¡¨è¾¾é‡å’Œ3Dç©ºé—´åæ ‡è¿›è¡Œæ‰©æ•£å»ºæ¨¡</b>
</p>

<p align="center">
	<img src="https://img.shields.io/badge/Python-3.12+-blue.svg" alt="Python">
	<img src="https://img.shields.io/badge/PyTorch-2.0+-red.svg" alt="PyTorch">
	<img src="https://img.shields.io/badge/Lightning-2.0+-purple.svg" alt="Lightning">
	<img src="https://img.shields.io/badge/License-MIT-green.svg" alt="License">
</p>

---

## ğŸ¯ é¡¹ç›®ç®€ä»‹

AlphaSTomics æ˜¯ä¸€ä¸ªå…ˆè¿›çš„ç©ºé—´è½¬å½•ç»„å­¦æ•°æ®å»ºæ¨¡æ¡†æ¶ï¼ŒåŸºäºæ‰©æ•£æ¨¡å‹å’Œ Transformer æ¶æ„ã€‚æ”¯æŒ**åŒæ¨¡æ€æ‰©æ•£**ï¼Œå¯ä»¥åŒæ—¶å¯¹åŸºå› è¡¨è¾¾é‡å’Œç©ºé—´åæ ‡è¿›è¡Œç”Ÿæˆä¸é‡å»ºã€‚

## æ ¸å¿ƒç‰¹æ€§ï¼ˆä¿ç•™ï¼‰
- åŒæ¨¡æ€ç”Ÿæˆï¼šè¡¨è¾¾é‡ + 3D åæ ‡
- Masked Diffusionï¼ˆç‰¹å¾çº§ maskingï¼‰
- è®­ç»ƒæ¨¡å¼ï¼š`expr_to_pos` / `pos_to_expr` / `joint`
- æŸå¤±ï¼šè¡¨è¾¾é‡ MSE + ä½ç½®è·ç¦»çŸ©é˜µ MSEï¼ˆæ—‹è½¬/å¹³ç§»ä¸å˜ï¼‰
- é«˜æ•ˆæ³¨æ„åŠ›ï¼šLinear Attentionï¼Œè¿‘ O(n)
- åˆ†å¸ƒå¼è®­ç»ƒï¼šæ”¯æŒ DDP / FSDP / DeepSpeed



---

## **åŠŸèƒ½ä¸€ï¼šåŒæ¨¡æ€ç”Ÿæˆ**
- **è¯´æ˜**: åŒæ—¶å»ºæ¨¡åŸºå› è¡¨è¾¾ï¼ˆexpression, (B,N,G)ï¼‰å’Œ 3D åæ ‡ï¼ˆposition, (B,N,3)ï¼‰ã€‚

- **ç¤ºä¾‹**:

```python
from diffusion_model import DiffusionSampler
# sampler.sample è¿”å› (expression, positions)
expression, positions = sampler.sample(expr, pos, mask, mode='joint')
```

---

## **åŠŸèƒ½äºŒï¼šMasked Diffusion (MDT)**
- **è¯´æ˜**: å¯¹æ¯ä¸ªç»†èƒå†…éƒ¨çš„ç‰¹å¾ç»´åº¦ï¼ˆåŸºå› æˆ– x/y/zï¼‰è¿›è¡Œ maskï¼Œé‡å»ºæŸå¤±ä»…åœ¨ mask ä¸Šè®¡ç®—ã€‚

- **ç¤ºä¾‹ï¼ˆå¯ç”¨ï¼‰**:

```python
# config['masking'] æ§åˆ¶ MDT
cfg['masking'] = {'enable': True, 'expression_mask_ratio':0.4}
model = AlphaSTomicsModule(cfg, num_genes)
```

---

## **åŠŸèƒ½ä¸‰ï¼šè®­ç»ƒæ¨¡å¼**
- **è¯´æ˜**: æ”¯æŒ `expr_to_pos`, `pos_to_expr`, `joint` ä¸‰ç§æ¨¡å¼ã€‚

- **ç¤ºä¾‹**:

```bash
python -m alphastomics.main train --config config.yaml --data_mode slice
```

æˆ–åœ¨ä»£ç ä¸­ï¼š

```python
cfg['training_mode'] = 'expr_to_pos'
```

---

## **åŠŸèƒ½å››ï¼šæŸå¤±è®¾è®¡**
- **è¯´æ˜**: è¡¨è¾¾é‡ä½¿ç”¨ MSEï¼›ä½ç½®ä½¿ç”¨è·ç¦»çŸ©é˜µ MSEï¼ˆæ—‹è½¬/å¹³ç§»ä¸å˜ï¼‰ï¼›å¯é€‰ masked reconstruction åŠ æƒã€‚

- **ç¤ºä¾‹**:

```python
loss = DualModalLoss(lambda_expression=1.0, lambda_position=1.0, lambda_masked_reconstruction=0.5)
L = loss(pred_expr, pred_pos, true_expr, true_pos, mask_info)
```

---

## **åŠŸèƒ½äº”ï¼šé«˜æ•ˆæ³¨æ„åŠ›ä¸å¯æ‰©å±•æ€§**
- **è¯´æ˜**: ä½¿ç”¨ Linear Attentionï¼Œæ—¶ç©ºå¤æ‚åº¦è¿‘ O(n)ï¼Œä¾¿äºå¤„ç†å¤§åºåˆ—æˆ–é«˜ç»†èƒæ•°ã€‚

---

## **åŠŸèƒ½å…­ï¼šé‡‡æ ·å™¨æ¥å£**
- **è¯´æ˜**: `diffusion_model/sample.py` æä¾› `expr_to_pos` / `pos_to_expr` / `joint`ã€‚

- **ç¤ºä¾‹**:

```python
pos = DiffusionSampler(model, noise_model).sample(expr, pos, mask, mode='expr_to_pos')[1]
```

---

## **åŠŸèƒ½ä¸ƒï¼šæ•°æ®ä¸éƒ¨ç½²**
- **è¯´æ˜**: `utils/dataholder.py` æä¾›ç»Ÿä¸€æ•°æ®å®¹å™¨ï¼›æ”¯æŒ `slice` å’Œ `cell` ä¸¤ç§åŠ è½½æ¨¡å¼ï¼›åŸºäº PyTorch Lightning æ”¯æŒ DDP/FSDP/DeepSpeedã€‚

---

## **å¿«é€Ÿå®‰è£…ä¸æœ¬åœ°éªŒè¯**

```bash
# macOS / zsh (é¡¹ç›®æ ¹ç›®å½•)
python -m venv .venv
source .venv/bin/activate
pip install --upgrade pip
pip install torch pytorch-lightning pyyaml wandb
pip install -e .

# å¿«é€Ÿå¯¼å…¥æµ‹è¯•
python -c "from diffusion_model import MaskedDiffusionModule; print('OK')"
```

---

æ›´å¤šé…ç½®ç»†èŠ‚è§ `config.yaml`ï¼ŒMDT ä½¿ç”¨è¯´æ˜è§ `docs/MASKED_DIFFUSION.md`ã€‚

| **ä½ç½®** | Distance Matrix MSE, Procrustes | å‡ ä½•é‡å»ºç²¾åº¦ |
| **ç©ºé—´** | kNN Preservation, Moran's I | ç©ºé—´ç»“æ„ä¿æŒ |
| **èšç±»** | ARI, NMI, Accuracy | ç»†èƒç±»å‹èšç±»æ•ˆæœ |

---

## ğŸ“Š æ•°å­¦åŸç†

### å‰å‘æ‰©æ•£è¿‡ç¨‹

å¯¹äºæ—¶é—´æ­¥ $t \in [1, T]$ï¼š

$$z_t = \alpha_t \cdot x_0 + \sigma_t \cdot \epsilon, \quad \epsilon \sim \mathcal{N}(0, I)$$

å…¶ä¸­ $\alpha_t$ å’Œ $\sigma_t$ åŸºäº cosine schedule è®¡ç®—ã€‚

### é€†å‘é‡‡æ ·è¿‡ç¨‹

ä» $z_T$ é€æ­¥å»å™ªåˆ° $z_0$ï¼š

$$z_s = c_1 \cdot z_t + c_2 \cdot \hat{x}_0 + \sigma_{t \to s} \cdot \epsilon$$

å…¶ä¸­ $\hat{x}_0$ æ˜¯æ¨¡å‹å¯¹åŸå§‹æ•°æ®çš„é¢„æµ‹ï¼ˆxâ‚€-predictionï¼‰ã€‚

### æŸå¤±å‡½æ•°

**è¡¨è¾¾é‡æŸå¤±** (MSE)ï¼š

$$\mathcal{L}_{expr} = \frac{1}{N \cdot G} \sum_{i,g} (x_{expr}^{(i,g)} - \hat{x}_{expr}^{(i,g)})^2$$

**ä½ç½®æŸå¤±** (è·ç¦»çŸ©é˜µ MSEï¼Œæ—‹è½¬å¹³ç§»ä¸å˜)ï¼š

$$\mathcal{L}_{pos} = \frac{1}{N^2} \sum_{i,j} (D_{true}^{(i,j)} - D_{pred}^{(i,j)})^2$$

å…¶ä¸­ $D^{(i,j)} = \|pos_i - pos_j\|_2$

---

## ğŸ”§ ç›¸å¯¹äº LUNA çš„æ”¹è¿›

| æ¨¡å— | LUNA | AlphaSTomics | æ”¹è¿›è¯´æ˜ |
|------|------|--------------|---------|
| **åæ ‡ç»´åº¦** | 2D | 3D CCF | æ”¯æŒé…å‡†åçš„ä¸‰ç»´ç©ºé—´æ•°æ® |
| **æ‰©æ•£æ¨¡æ€** | ä»…ä½ç½® | è¡¨è¾¾é‡ + ä½ç½® | åŒæ¨¡æ€è”åˆæ‰©æ•£ |
| **åŸºå› é€‰æ‹©** | é«˜å˜å¼‚åŸºå›  | å…¨åŸºå›  | æ”¯æŒå¤šå¹³å°æ•°æ®ç»Ÿä¸€ |
| **æ³¨æ„åŠ›** | Linear Attention | Linear Attention | O(nÂ²) â†’ O(n) |
| **é‡‡æ ·æ¨¡å¼** | å•å‘ | åŒå‘ + è”åˆ | æ›´çµæ´»çš„ç”Ÿæˆèƒ½åŠ› |
| **åˆ†å¸ƒå¼** | ä¸æ”¯æŒ | DDP/FSDP/DeepSpeed | å¤šæœºå¤šå¡è®­ç»ƒ |

---

## ğŸ“š å‚è€ƒ

- [LUNA: Tissue reassembly with generative AI](https://github.com/mlbio-epfl/LUNA)
- [Denoising Diffusion Probabilistic Models](https://arxiv.org/abs/2006.11239)

---

## ğŸ“„ è®¸å¯è¯

MIT License