# AlphaSTomics - åŒæ¨¡æ€ç©ºé—´è½¬å½•ç»„æ‰©æ•£æ¨¡å‹

<p align="center">
<b>åŒæ—¶å¯¹åŸºå› è¡¨è¾¾é‡å’Œ3Dç©ºé—´åæ ‡è¿›è¡Œæ‰©æ•£å»ºæ¨¡</b>
</p>

<p align="center">
<img src="https://img.shields.io/badge/Python-3.12+-blue.svg" alt="Python">
<img src="https://img.shields.io/badge/PyTorch-2.0+-red.svg" alt="PyTorch">
<img src="https://img.shields.io/badge/Lightning-2.0+-purple.svg" alt="Lightning">
<img src="https://img.shields.io/badge/HuggingFace-Compatible-yellow.svg" alt="HuggingFace">
<img src="https://img.shields.io/badge/License-MIT-green.svg" alt="License">
</p>

---

## ğŸ¯ é¡¹ç›®ç®€ä»‹

AlphaSTomics æ˜¯ä¸€ä¸ªå…ˆè¿›çš„ç©ºé—´è½¬å½•ç»„å­¦æ•°æ®å»ºæ¨¡æ¡†æ¶ï¼ŒåŸºäºæ‰©æ•£æ¨¡å‹å’Œ Transformer æ¶æ„ã€‚æ”¯æŒ**åŒæ¨¡æ€æ‰©æ•£**ï¼Œå¯ä»¥åŒæ—¶å¯¹åŸºå› è¡¨è¾¾é‡å’Œç©ºé—´åæ ‡è¿›è¡Œç”Ÿæˆä¸é‡å»ºã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### åŸºç¡€èƒ½åŠ›
- ğŸ§¬ **åŒæ¨¡æ€ç”Ÿæˆ**ï¼šè¡¨è¾¾é‡ + 3D åæ ‡è”åˆæ‰©æ•£
- ğŸ­ **Masked Diffusion**ï¼šç‰¹å¾çº§ maskingï¼Œæå‡é‡å»ºè´¨é‡
- ğŸ”„ **è®­ç»ƒæ¨¡å¼**ï¼š`expr_to_pos` / `pos_to_expr` / `joint`
- ğŸ“ **æ—‹è½¬ä¸å˜æŸå¤±**ï¼šä½ç½®ä½¿ç”¨è·ç¦»çŸ©é˜µ MSE
- ğŸš€ **åˆ†å¸ƒå¼è®­ç»ƒ**ï¼šæ”¯æŒ DDP / FSDP / DeepSpeed
- ğŸ“¦ **HuggingFace å…¼å®¹**ï¼šParquet æ ¼å¼ï¼Œæ”¯æŒæµå¼åŠ è½½

### é«˜çº§ç‰¹æ€§ï¼ˆæ–°å¢ï¼‰
- âš¡ **Gated Attention**ï¼šåŸºäº Qwen3 çš„é—¨æ§æ³¨æ„åŠ›æœºåˆ¶ï¼ˆNeurIPS 2025 Oralï¼‰
  - Headwise / Elementwise é—¨æ§
  - QK Normalization (RMSNorm)
  - Attention-sink é˜²æ­¢
  - å‚æ•°å‡å°‘ 37%ï¼Œæ€§èƒ½æå‡
  
- ğŸ¯ **Mixture of Experts (MoE)**ï¼šç¨€ç–æ¿€æ´»çš„ä¸“å®¶ç½‘ç»œ
  - Top-K ä¸“å®¶é€‰æ‹©ï¼ˆå¦‚ 8 é€‰ 2ï¼‰
  - è´Ÿè½½å‡è¡¡æœºåˆ¶
  - æ€»å‚æ•°ä¸ Dense ç›¸è¿‘ï¼Œæ¿€æ´»å‚æ•°ä»… 50%ï¼ˆ4 é€‰ 2ï¼‰
  - é€‚åˆå¤§è§„æ¨¡æ•°æ®é›†

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å®‰è£…

```bash
# å…‹éš†ä»“åº“
git clone https://github.com/zEpoch/alphaStomics.git
cd alphaStomics

# åˆ›å»ºç¯å¢ƒ
conda create -n alphastomics python=3.12
conda activate alphastomics

# å®‰è£…ä¾èµ–
pip install --upgrade pip
pip install torch pytorch-lightning pyyaml wandb scanpy anndata pyarrow
pip install -e .

# éªŒè¯å®‰è£…
python -c "from alphastomics.diffusion_model import MaskedDiffusionModule; print('OK')"
```

### è®­ç»ƒæ¨¡å‹

AlphaSTomics æä¾›ä¸¤ç§è®­ç»ƒæ–¹å¼ï¼š

#### æ–¹å¼ 1ï¼šä½¿ç”¨ç‹¬ç«‹è®­ç»ƒè„šæœ¬ `train.py`

é€‚åˆå¿«é€Ÿå®éªŒå’Œç®€å•é…ç½®ï¼š

```bash
# åŸºç¡€è®­ç»ƒï¼ˆä½¿ç”¨é»˜è®¤é…ç½®ï¼‰
python train.py \
    --config config.yaml \
    --data_dir ./processed_data \
    --num_genes 2000 \
    --exp_name my_experiment

# å¯ç”¨ Gated Attention
python train.py \
    --config config.yaml \
    --data_dir ./processed_data \
    --num_genes 2000 \
    --use_gated_attention \
    --exp_name gated_experiment

# å¯ç”¨ MoEï¼ˆ4 ä¸“å®¶ï¼Œæ¿€æ´» 2 ä¸ªï¼‰
python train.py \
    --config config.yaml \
    --data_dir ./processed_data \
    --num_genes 2000 \
    --use_moe \
    --num_experts 4 \
    --num_genes 2000 \
    --use_gated_attention \
    --use_moe \
    --num_experts 4 \
    --moe_top_k 2 \
    --exp_name gated_moe_experiment

# å¯ç”¨ Masked Diffusion
python train.py \
    --config config.yaml \
    --data_dir ./processed_data \
    --num_genes 2000 \
    --enable_masking \
    --expression_mask_ratio 0.3 \
    --position_mask_ratio 0.33 \
    --exp_name masked_experiment

# è‡ªå®šä¹‰è®­ç»ƒå‚æ•°
python train.py \
    --config config.yaml \
    --data_dir ./processed_data \
    --num_genes 2000 \
    --batch_size 64 \
    --epochs 100 \
    --lr 1e-4 \
    --training_mode joint \
    --gpus 2 \
    --fp16 \
    --exp_name custom_experiment
```

#### æ–¹å¼ 2ï¼šä½¿ç”¨æ¨¡å—åŒ–å‘½ä»¤ `python -m alphastomics.main`

é€‚åˆç”Ÿäº§ç¯å¢ƒå’Œæµæ°´çº¿é›†æˆï¼š

```bash
# åŸºç¡€è®­ç»ƒ
python -m alphastomics.main train \
    --config config.yaml \
    --data_dir ./processed_data

# å¯ç”¨ Gated Attention
python -m alphastomics.main train \
    --config config.yaml \
    --use_gated_attention

# å¯ç”¨ MoE
python -m alphastomics.main train \
    --config config.yaml \
    --use_moe \
    --num_experts 4 \
    --moe_top_k 2

# å®Œæ•´é…ç½®ï¼ˆGated Attention + MoE + Masked Diffusionï¼‰
python -m alphastomics.main train \
    --config config.yaml \
    --use_gated_attention \
    --gate_type elementwise \
    --use_moe \
    --num_experts 8 \
    --moe_top_k 2 \
    --enable_masking \
    --expression_mask_ratio 0.3 \
    --position_mask_ratio 0.33 \
    --batch_size 64 \
    --epochs 100 \
    --lr 1e-4
```

ä¸¤ç§æ–¹å¼çš„ä¸»è¦åŒºåˆ«ï¼š
- `train.py`: ç‹¬ç«‹è„šæœ¬ï¼Œéœ€è¦æŒ‡å®š `--num_genes` å’Œ `--exp_name`
- `python -m alphastomics.main`: æ¨¡å—åŒ–æ¥å£ï¼Œæ”¯æŒå®Œæ•´çš„å­å‘½ä»¤æµç¨‹ï¼ˆpreprocess, train, test, sample ç­‰ï¼‰

### å¿«é€Ÿæµ‹è¯•

```bash
# æµ‹è¯• Gated Attention
python demo_gated.py

# æµ‹è¯• Gated Attention + MoE
python demo_gated_moe.py

# å¯¹æ¯”å››ç§é…ç½®
python compare_configs.py
```

---

## ğŸ“‹ å‘½ä»¤è¡Œå‚æ•°

### è®­ç»ƒå‚æ•°

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `--config` | é…ç½®æ–‡ä»¶è·¯å¾„ | `config.yaml` |
| `--data_dir` | æ•°æ®ç›®å½•ï¼ˆå¿…éœ€ï¼‰ | - |
| `--num_genes` | åŸºå› æ•°é‡ï¼ˆå¿…éœ€ï¼‰ | - |
| `--batch_size` | æ‰¹æ¬¡å¤§å° | é…ç½®æ–‡ä»¶ |
| `--epochs` | è®­ç»ƒè½®æ•° | é…ç½®æ–‡ä»¶ |
| `--lr` | å­¦ä¹ ç‡ | é…ç½®æ–‡ä»¶ |
| `--training_mode` | è®­ç»ƒæ¨¡å¼ï¼š`joint`/`expr_to_pos`/`pos_to_expr` | é…ç½®æ–‡ä»¶ |

### Gated Attention å‚æ•°

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `--use_gated_attention` | å¯ç”¨ Gated Attention | False |
| `--no_gated_attention` | ç¦ç”¨ Gated Attention | - |
| `--gate_type` | é—¨æ§ç±»å‹ï¼š`headwise`/`elementwise` | `headwise` |

### MoE å‚æ•°

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `--use_moe` | å¯ç”¨ MoE | False |
| `--no_moe` | ç¦ç”¨ MoE | - |
| `--num_experts` | ä¸“å®¶æ•°é‡ | 4 |
| `--moe_top_k` | æ¯æ¬¡æ¿€æ´»çš„ä¸“å®¶æ•° | 2 |

### Masked Diffusion å‚æ•°

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `--enable_masking` | å¯ç”¨ Masked Diffusion | False |
| `--disable_masking` | ç¦ç”¨ Masked Diffusion | - |
| `--expression_mask_ratio` | è¡¨è¾¾é‡é®ç½©æ¯”ä¾‹ | 0.3 |
| `--position_mask_ratio` | ä½ç½®é®ç½©æ¯”ä¾‹ | 0.33 |

### å…¶ä»–å‚æ•°

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `--output_dir` | è¾“å‡ºç›®å½• | `./outputs` |
| `--exp_name` | å®éªŒåç§° | `alphastomics` |
| `--resume_from` | ä»æ£€æŸ¥ç‚¹æ¢å¤ | None |
| `--gpus` | GPU æ•°é‡ | 1 |
| `--num_workers` | æ•°æ®åŠ è½½çº¿ç¨‹æ•° | 4 |
| `--seed` | éšæœºç§å­ | 42 |
| `--fp16` | æ··åˆç²¾åº¦è®­ç»ƒ | False |

---

## ğŸ“ é¡¹ç›®ç»“æ„

```plaintext
alphaStomics/
â”œâ”€â”€ alphastomics/
â”‚   â”œâ”€â”€ diffusion_model/        # æ‰©æ•£æ¨¡å‹æ ¸å¿ƒ
â”‚   â”‚   â”œâ”€â”€ module.py           # PyTorch Lightning æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ noise.py            # å™ªå£°æ¨¡å‹ï¼ˆcosine scheduleï¼‰
â”‚   â”‚   â”œâ”€â”€ loss.py             # åŒæ¨¡æ€æŸå¤±å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ sample.py           # é‡‡æ ·å™¨
â”‚   â”‚   â””â”€â”€ train.py            # è®­ç»ƒé€»è¾‘
â”‚   â”œâ”€â”€ attn_model/             # æ³¨æ„åŠ›æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ model.py            # ä¸»æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ transformer.py      # Transformer ç¼–ç å™¨
â”‚   â”‚   â”œâ”€â”€ gated_attention.py  # Gated Attentionï¼ˆæ–°å¢ï¼‰
â”‚   â”‚   â”œâ”€â”€ moe.py              # Mixture of Expertsï¼ˆæ–°å¢ï¼‰
â”‚   â”‚   â””â”€â”€ layers.py           # åŸºç¡€å±‚
â”‚   â””â”€â”€ utils/                  # å·¥å…·å‡½æ•°
â”‚       â”œâ”€â”€ dataholder.py       # æ•°æ®å®¹å™¨
â”‚       â””â”€â”€ metrics.py          # è¯„ä¼°æŒ‡æ ‡
â”œâ”€â”€ train.py                    # ä¸»è®­ç»ƒè„šæœ¬ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ demo_gated.py               # Gated Attention æ¼”ç¤º
â”œâ”€â”€ demo_gated_moe.py           # Gated + MoE æ¼”ç¤º
â”œâ”€â”€ compare_configs.py          # é…ç½®å¯¹æ¯”è„šæœ¬
â”œâ”€â”€ config.yaml                 # é»˜è®¤é…ç½®
â”œâ”€â”€ GATED_ATTENTION.md          # Gated Attention æ–‡æ¡£
â”œâ”€â”€ GATED_MOE_GUIDE.md          # MoE è¯¦ç»†æŒ‡å—
â”œâ”€â”€ DEMO_USAGE.md               # Demo ä½¿ç”¨æŒ‡å—
â””â”€â”€ README.MD
```

### é¢„å¤„ç†å‘½ä»¤

#### `preprocess` - ä¸€æ­¥å®Œæˆé¢„å¤„ç†ï¼ˆæ¨èå•æ•°æ®é›†ï¼‰

```bash
python -m alphastomics.main preprocess \
    --input_dir ./raw_h5ad \           # è¾“å…¥ h5ad æ–‡ä»¶ç›®å½•
    --output_dir ./processed \          # è¾“å‡ºç›®å½•
    --gene_list_file genes.txt \        # å›ºå®šåŸºå› åˆ—è¡¨ï¼ˆæ¨èï¼‰
    --position_key spatial \            # åæ ‡å­—æ®µåï¼ˆé»˜è®¤: spatialï¼‰
    --position_is_3d \                  # åæ ‡æ˜¯å¦ä¸º 3D
    --z_spacing 10.0 \                  # åˆ‡ç‰‡é—´ z é—´è·ï¼ˆ2D æ—¶ä½¿ç”¨ï¼‰
    --cell_type_key cell_type \         # ç»†èƒç±»å‹å­—æ®µï¼ˆå¯é€‰ï¼Œé¢„è®­ç»ƒä¸éœ€è¦ï¼‰
    --skip-log-normalize \              # è·³è¿‡ log normalizeï¼ˆæ•°æ®å·²å¤„ç†æ—¶ï¼‰
    --skip-scale \                      # è·³è¿‡ scale
    --train_ratio 0.8 \                 # è®­ç»ƒé›†æ¯”ä¾‹
    --val_ratio 0.1 \                   # éªŒè¯é›†æ¯”ä¾‹
    --max_shard_size 100000             # æ¯ä¸ªåˆ†ç‰‡æœ€å¤§ç»†èƒæ•°
```

#### `stage1` + `stage2` - åˆ†æ­¥é¢„å¤„ç†ï¼ˆé€‚åˆå¤šæ•°æ®é›†åˆå¹¶ï¼‰

**åœºæ™¯**ï¼šä¸åŒæ•°æ®é›†éœ€è¦ä¸åŒçš„é¢„å¤„ç†å‚æ•°ï¼ˆå¦‚æœ‰çš„éœ€è¦ log normalizeï¼Œæœ‰çš„ä¸éœ€è¦ï¼‰

```bash
# æ•°æ®é›† Aï¼šéœ€è¦ log normalize
python -m alphastomics.main stage1 \
    --input_dir ./dataset_A \
    --output_dir ./intermediate/A \
    --gene_list_file genes.txt          # å¿…é¡»ä½¿ç”¨ç›¸åŒçš„åŸºå› åˆ—è¡¨ï¼

# æ•°æ®é›† Bï¼šå·²ç» log normalizedï¼Œè·³è¿‡
python -m alphastomics.main stage1 \
    --input_dir ./dataset_B \
    --output_dir ./intermediate/B \
    --gene_list_file genes.txt \
    --skip-log-normalize

# åˆå¹¶æ‰€æœ‰æ•°æ®é›†ï¼Œç”Ÿæˆæœ€ç»ˆ Parquet
python -m alphastomics.main stage2 \
    --input_dirs ./intermediate/A ./intermediate/B \
    --output_dir ./final_dataset \
    --train_ratio 0.8 \
    --val_ratio 0.1
```

**âš ï¸ é‡è¦**ï¼šåˆå¹¶å¤šæ•°æ®é›†æ—¶ï¼Œæ‰€æœ‰ `stage1` å¿…é¡»ä½¿ç”¨**ç›¸åŒçš„åŸºå› åˆ—è¡¨æ–‡ä»¶**ï¼

**é¢„å¤„ç†æµç¨‹**ï¼š
1. **Stage 1**ï¼šå¯¹æ¯ä¸ªåˆ‡ç‰‡è¿›è¡Œ log normalize + scaleï¼ˆå¯é€‰ï¼‰ï¼Œä¿å­˜ä¸­é—´æ ¼å¼
2. **Stage 2**ï¼šè·¨åˆ‡ç‰‡éšæœºé‡‡æ ·ï¼Œç”Ÿæˆ train/val/test åˆ†å‰²ï¼Œåºåˆ—åŒ–ä¸º Parquet

**ç‰¹ç‚¹**ï¼š
- å†…å­˜å‹å¥½ï¼šæµå¼å¤„ç†ï¼Œä¸éœ€è¦ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ•°æ®
- æ— æ”¾å›é‡‡æ ·ï¼šæ¯ä¸ªç»†èƒæ°å¥½å‡ºç°ä¸€æ¬¡
- ç»†èƒçº§åˆ†å‰²ï¼šåŒä¸€åˆ‡ç‰‡å¯èƒ½è¢«åˆ†åˆ°ä¸åŒé›†åˆ
- åŸºå› è¡¥å…¨ï¼šç¼ºå¤±åŸºå› è‡ªåŠ¨è¡¥ 0

### è®­ç»ƒå‘½ä»¤

```bash
python -m alphastomics.main train \
    --config ./config.yaml \         # é…ç½®æ–‡ä»¶
    --data_dir ./processed \         # æ•°æ®ç›®å½•
    --batch_size 1024 \              # æ‰¹æ¬¡å¤§å°
    --streaming \                    # æµå¼åŠ è½½ï¼ˆå¤§æ•°æ®é›†æ¨èï¼‰
    --buffer_size 50000 \            # shuffle buffer å¤§å°
    --resume ./checkpoint.ckpt \     # æ¢å¤è®­ç»ƒ
    --test_after_train               # è®­ç»ƒåè‡ªåŠ¨æµ‹è¯•
```

### å…¶ä»–å‘½ä»¤

```bash
# æµ‹è¯•
python -m alphastomics.main test --checkpoint model.ckpt --data_dir ./data

# é‡‡æ ·
python -m alphastomics.main sample --checkpoint model.ckpt --input_data input.pt --sample_mode joint

# æå– embedding
python -m alphastomics.main extract --checkpoint model.ckpt --data_dir ./data --output embeddings.npz

# ä¸Šä¼ åˆ° HuggingFace
python -m alphastomics.main upload --data_dir ./processed --repo_id org/dataset-name --private
```

---

## ğŸ“Š è¾“å…¥æ•°æ®æ ¼å¼

### h5ad æ–‡ä»¶è¦æ±‚

```python
import scanpy as sc
adata = sc.read_h5ad("slice.h5ad")

# å¿…éœ€å­—æ®µ
adata.X                    # åŸºå› è¡¨è¾¾çŸ©é˜µ (n_cells, n_genes)
adata.obsm['spatial']      # ç©ºé—´åæ ‡ (n_cells, 2) æˆ– (n_cells, 3)

# å¯é€‰å­—æ®µ
adata.obs['cell_type']     # ç»†èƒç±»å‹æ ‡ç­¾ï¼ˆé¢„è®­ç»ƒæ—¶ä¸éœ€è¦ï¼‰
adata.var_names            # åŸºå› åç§°
```

### é¢„å¤„ç†è¾“å‡ºæ ¼å¼ï¼ˆParquetï¼‰

```
processed_data/
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ train.parquet          # æˆ– train-00000.parquet, train-00001.parquet, ...
â”‚   â”œâ”€â”€ validation.parquet
â”‚   â””â”€â”€ test.parquet
â”œâ”€â”€ metadata.json              # åŸºå› åˆ—è¡¨ã€ç»Ÿè®¡ä¿¡æ¯
â””â”€â”€ _intermediate_slices/      # ä¸­é—´æ–‡ä»¶ï¼ˆå¯åˆ é™¤ï¼‰
```

æ¯ä¸ª Parquet æ–‡ä»¶åŒ…å«ï¼š
- `expression`: å½’ä¸€åŒ–åçš„åŸºå› è¡¨è¾¾å‘é‡
- `position`: æ ‡å‡†åŒ–åçš„ 3D åæ ‡
- `cell_type`: ç»†èƒç±»å‹ï¼ˆå¯é€‰ï¼‰
- `slice_id`: æ¥æºåˆ‡ç‰‡ ID

---

## âš™ï¸ é…ç½®æ–‡ä»¶

```yaml
# config.yaml

# éšæœºç§å­ï¼ˆç¡®ä¿å¯å¤ç°ï¼‰
seed:
  global_seed: 42
  deterministic: false    # true ä¼šé™ä½æ€§èƒ½ä½†ä¿è¯å®Œå…¨å¤ç°

model:
  num_genes: 20000           # åŸºå› æ•°é‡
  d_model: 256               # æ¨¡å‹ç»´åº¦
  n_heads: 8                 # æ³¨æ„åŠ›å¤´æ•°
  n_layers: 6                # Transformer å±‚æ•°
  dropout: 0.1

diffusion:
  num_timesteps: 1000        # æ‰©æ•£æ­¥æ•°
  schedule: cosine           # å™ªå£°è°ƒåº¦
  prediction_type: x0        # é¢„æµ‹ç±»å‹

training:
  mode: joint                # è®­ç»ƒæ¨¡å¼ï¼šjoint/expr_to_pos/pos_to_expr
  batch_size: 1024
  learning_rate: 1e-4
  max_epochs: 100

masking:
  enable: true               # å¯ç”¨ Masked Diffusion
  expression_mask_ratio: 0.4
  position_mask_ratio: 0.3

data:
  processed_data_dir: ./processed
  preprocessing:
    normalize_position: false  # ä¸å¯¹åæ ‡å½’ä¸€åŒ–ï¼ˆä¿æŒåŸå§‹ CCFï¼‰
    scale: true
  loading:
    num_workers: 4
```

---

## ğŸ”¬ æ ¸å¿ƒåŠŸèƒ½è¯¦è§£

### åŠŸèƒ½ä¸€ï¼šåŒæ¨¡æ€ç”Ÿæˆ

åŒæ—¶å»ºæ¨¡åŸºå› è¡¨è¾¾ `(B, N, G)` å’Œ 3D åæ ‡ `(B, N, 3)`ã€‚

```python
from alphastomics.diffusion_model import DiffusionSampler

sampler = DiffusionSampler(model, noise_model)
expression, positions = sampler.sample(expr, pos, mask, mode='joint')
```

### åŠŸèƒ½äºŒï¼šMasked Diffusion (MDT)

å¯¹æ¯ä¸ªç»†èƒå†…éƒ¨çš„ç‰¹å¾ç»´åº¦è¿›è¡Œ maskï¼Œé‡å»ºæŸå¤±ä»…åœ¨ mask ä¸Šè®¡ç®—ã€‚

```python
cfg['masking'] = {
    'enable': True, 
    'expression_mask_ratio': 0.4,
    'position_mask_ratio': 0.3
}
model = AlphaSTomicsModule(cfg, num_genes)
```

### åŠŸèƒ½ä¸‰ï¼šè®­ç»ƒæ¨¡å¼

- `expr_to_pos`: è¡¨è¾¾é‡ â†’ ä½ç½®
- `pos_to_expr`: ä½ç½® â†’ è¡¨è¾¾é‡
- `joint`: è”åˆæ‰©æ•£

### åŠŸèƒ½å››ï¼šæŸå¤±è®¾è®¡

- **è¡¨è¾¾é‡æŸå¤±**: MSE
- **ä½ç½®æŸå¤±**: è·ç¦»çŸ©é˜µ MSEï¼ˆæ—‹è½¬/å¹³ç§»ä¸å˜ï¼‰
- **Masked Reconstruction**: å¯é€‰åŠ æƒ

```python
loss = DualModalLoss(
    lambda_expression=1.0, 
    lambda_position=1.0, 
    lambda_masked_reconstruction=0.5
)
```

### åŠŸèƒ½äº”ï¼šæµå¼æ•°æ®åŠ è½½

æ”¯æŒ HuggingFace Datasets é£æ ¼çš„æµå¼åŠ è½½ï¼Œé€‚ç”¨äºå¤§è§„æ¨¡æ•°æ®é›†ã€‚

```python
from alphastomics.preprocessing.batch_loader import create_dataloaders

train_loader, val_loader, test_loader = create_dataloaders(
    data_dir="./processed",
    batch_size=64,
    streaming=True,       # å¯ç”¨æµå¼åŠ è½½
    buffer_size=50000     # shuffle buffer å¤§å°
)
```

---

## ğŸ“Š æ•°å­¦åŸç†

### å‰å‘æ‰©æ•£è¿‡ç¨‹
 
å¯¹äºæ—¶é—´æ­¥ $t \in [1, T]$ï¼š

$$z_t = \alpha_t \cdot x_0 + \sigma_t \cdot \epsilon, \quad \epsilon \sim \mathcal{N}(0, I)$$

å…¶ä¸­ $\alpha_t$ å’Œ $\sigma_t$ åŸºäº cosine schedule è®¡ç®—ã€‚

### é€†å‘é‡‡æ ·è¿‡ç¨‹

ä» $z_T$ é€æ­¥å»å™ªåˆ° $z_0$ï¼š

$$z_s = c_1 \cdot z_t + c_2 \cdot \hat{x}_0 + \sigma_{t \to s} \cdot \epsilon$$

å…¶ä¸­ $\hat{x}_0$ æ˜¯æ¨¡å‹å¯¹åŸå§‹æ•°æ®çš„é¢„æµ‹ï¼ˆxâ‚€-predictionï¼‰ã€‚

### æŸå¤±å‡½æ•°

**è¡¨è¾¾é‡æŸå¤±** (MSE)ï¼š

$$\mathcal{L}_{expr} = \frac{1}{N \cdot G} \sum_{i,g} (x_{expr}^{(i,g)} - \hat{x}_{expr}^{(i,g)})^2$$

**ä½ç½®æŸå¤±** (è·ç¦»çŸ©é˜µ MSEï¼Œæ—‹è½¬å¹³ç§»ä¸å˜)ï¼š

$$\mathcal{L}_{pos} = \frac{1}{N^2} \sum_{i,j} (D_{true}^{(i,j)} - D_{pred}^{(i,j)})^2$$

å…¶ä¸­ $D^{(i,j)} = \|pos_i - pos_j\|_2$

---

## âš™ï¸ é…ç½®å¯¹æ¯”ä¸æ€§èƒ½

### å››ç§æ³¨æ„åŠ›é…ç½®å¯¹æ¯”

è¿è¡Œ `python compare_configs.py` å¯ä»¥å¯¹æ¯”ä»¥ä¸‹å››ç§é…ç½®çš„æ€§èƒ½ï¼š

| é…ç½® | æ€»å‚æ•° | æ¿€æ´»å‚æ•° | FFN æ¿€æ´»æ¯”ä¾‹ | é€‚ç”¨åœºæ™¯ |
|------|--------|----------|-------------|---------|
| **Baseline** (Linear Attn) | 707K | 707K | 100% | åŸºç¡€æ¨¡å‹ |
| **Gated Attention** | 445K (-37%) | 445K | 100% | **æ¨è**ï¼šå‚æ•°å°‘ï¼Œæ€§èƒ½å¥½ |
| **MoE Only** (4 é€‰ 2) | 710K (+0.4%) | 644K (-9%) | 50.8% | å‚æ•°æ•ˆç‡ä¼˜å…ˆ |
| **Gated + MoE** | 448K (-37%) | 382K (-46%) | 50.8% | **æœ€å¼º**ï¼šå¤§è§„æ¨¡æ•°æ®é›† |

### å…³é”®å‘ç°

**1. Gated Attentionï¼ˆä¼˜å…ˆæ¨èï¼‰**
- âœ… å‚æ•°å‡å°‘ 37%ï¼ˆç§»é™¤ Linear Attention ä¾èµ–ï¼‰
- âœ… æ€§èƒ½æå‡æ˜æ˜¾
- âœ… è®­ç»ƒç¨³å®šï¼Œæ˜“äºè°ƒä¼˜
- âœ… é€‚åˆä¸­å°è§„æ¨¡æ•°æ®é›†

**2. MoEï¼ˆå‚æ•°æ•ˆç‡ï¼‰**
- âœ… æ€»å‚æ•°å‡ ä¹ä¸å˜ï¼ˆ+0.4%ï¼‰
- âœ… FFN å±‚é¢æ¿€æ´» 50%ï¼ˆ4 é€‰ 2ï¼‰
- âœ… æ•´ä½“æ¨¡å‹æ¿€æ´» 90.7%ï¼ˆå› ä¸º MoE åªå ä¸€å°éƒ¨åˆ†ï¼‰
- âš ï¸ éœ€è¦è¶³å¤Ÿå¤§çš„æ•°æ®é›†æ‰èƒ½å……åˆ†åˆ©ç”¨ä¸“å®¶ç½‘ç»œ

**3. Gated + MoEï¼ˆæœ€å¼ºé…ç½®ï¼‰**
- âœ… å‚æ•°å‡å°‘ 37%ï¼Œæ¿€æ´»å‚æ•°å‡å°‘ 46%
- âœ… æœ€å¤§æ¨¡å‹å®¹é‡å’Œå‚æ•°æ•ˆç‡
- âœ… é€‚åˆå¤§è§„æ¨¡ã€å¤æ‚æ•°æ®é›†
- âš ï¸ éœ€è¦æ›´å¤šè°ƒä¼˜ï¼ˆload balancingï¼‰

### ä½¿ç”¨å»ºè®®

```bash
# ğŸ¥‡ ä¼˜å…ˆæ¨èï¼šGated Attentionï¼ˆelementwise é»˜è®¤ï¼Œæ€§èƒ½æœ€å¼ºï¼‰
python train.py --use_gated_attention ...

# ğŸ¥ˆ å¤§è§„æ¨¡æ•°æ®ï¼šGated + MoE
python train.py --use_gated_attention --use_moe --num_experts 8 --moe_top_k 2 ...

# ğŸ¥‰ å‚æ•°æ•ˆç‡ï¼šä»… MoE
python train.py --use_moe --num_experts 4 --moe_top_k 2 ...
```

### MoE å‚æ•°è¯´æ˜

**æ¿€æ´»å‚æ•°è®¡ç®—ï¼š**
- æ¯ä¸ªä¸“å®¶çš„éšè—å±‚å¤§å° = `d_ff / num_experts`
- æ€»å‚æ•° â‰ˆ Dense FFN çš„å‚æ•°é‡ï¼ˆç•¥å¤šä¸€ç‚¹ï¼Œå› ä¸ºæœ‰ Routerï¼‰
- æ¿€æ´»å‚æ•° = Dense Ã— (top_k / num_experts)

**ç¤ºä¾‹ï¼ˆ4 é€‰ 2ï¼‰ï¼š**
- Dense FFN: 65,920 å‚æ•°
- MoE æ€»å‚æ•°: 67,328 å‚æ•°ï¼ˆ1.02xï¼‰
- MoE æ¿€æ´»å‚æ•°: 34,176 å‚æ•°ï¼ˆ0.52xï¼Œçº¦ 50%ï¼‰

---

## ğŸ“ˆ è¯„ä¼°æŒ‡æ ‡

| ç±»åˆ« | æŒ‡æ ‡ | è¯´æ˜ |
|------|------|------|
| **è¡¨è¾¾é‡** | MSE, Pearson r, Cosine Sim | é‡å»ºç²¾åº¦ |
| **ä½ç½®** | Distance Matrix MSE, Procrustes | å‡ ä½•é‡å»ºç²¾åº¦ |
| **ç©ºé—´** | kNN Preservation, Moran's I | ç©ºé—´ç»“æ„ä¿æŒ |
| **èšç±»** | ARI, NMI, Accuracy | ç»†èƒç±»å‹èšç±»æ•ˆæœ |

---

## ğŸ”§ ç›¸å¯¹äº LUNA çš„æ”¹è¿›

| æ¨¡å— | LUNA | AlphaSTomics | æ”¹è¿›è¯´æ˜ |
|------|------|--------------|---------|
| **åæ ‡ç»´åº¦** | 2D | 3D CCF | æ”¯æŒé…å‡†åçš„ä¸‰ç»´ç©ºé—´æ•°æ® |
| **åæ ‡å¤„ç†** | å½’ä¸€åŒ–åˆ° [-0.5, 0.5] | ä¿æŒåŸå§‹åæ ‡ | ä¸ä¸¢å¤±åæ ‡ä¿¡æ¯ï¼Œå¯ç›´æ¥ä½¿ç”¨ |
| **æ‰©æ•£æ¨¡æ€** | ä»…ä½ç½® | è¡¨è¾¾é‡ + ä½ç½® | åŒæ¨¡æ€è”åˆæ‰©æ•£ |
| **åŸºå› é€‰æ‹©** | é«˜å˜å¼‚åŸºå›  | å…¨åŸºå› ï¼ˆå›ºå®šåˆ—è¡¨ï¼‰ | æ”¯æŒå¤šå¹³å°æ•°æ®ç»Ÿä¸€ï¼Œç¼ºå¤±è¡¥ 0 |
| **æ³¨æ„åŠ›** | Linear Attention | **Gated Attention** | Qwen3 é—¨æ§æ³¨æ„åŠ›ï¼Œå‚æ•°æ›´å°‘ |
| **ä¸“å®¶ç½‘ç»œ** | - | **MoE (å¯é€‰)** | ç¨€ç–æ¿€æ´»ï¼Œæå‡æ¨¡å‹å®¹é‡ |
| **é‡‡æ ·æ¨¡å¼** | å•å‘ | åŒå‘ + è”åˆ | æ›´çµæ´»çš„ç”Ÿæˆèƒ½åŠ› |
| **åˆ†å¸ƒå¼** | ä¸æ”¯æŒ | DDP/FSDP/DeepSpeed | å¤šæœºå¤šå¡è®­ç»ƒ |
| **æ•°æ®æ ¼å¼** | å†…å­˜åŠ è½½ | Parquet æµå¼ | æ”¯æŒå¤§è§„æ¨¡æ•°æ®é›† |
| **å¯å¤ç°æ€§** | æ—  | å…¨å±€ç§å­æ§åˆ¶ | å®Œå…¨å¯å¤ç°çš„å®éªŒ |

---

## ğŸ“š å‚è€ƒæ–‡çŒ®

- [LUNA: Tissue reassembly with generative AI](https://github.com/mlbio-epfl/LUNA)
- [Denoising Diffusion Probabilistic Models](https://arxiv.org/abs/2006.11239)
- [Qwen3 Gated Attention](https://arxiv.org/abs/...) - NeurIPS 2025 Oral
- [Mixture of Experts](https://arxiv.org/abs/...)
- [HuggingFace Datasets](https://huggingface.co/docs/datasets)

---

## ğŸ“– è¯¦ç»†æ–‡æ¡£

- [`GATED_ATTENTION.md`](GATED_ATTENTION.md) - Gated Attention è¯¦ç»†è¯´æ˜
- [`GATED_MOE_GUIDE.md`](GATED_MOE_GUIDE.md) - MoE è¯¦ç»†æŒ‡å—å’Œæœ€ä½³å®è·µ
- [`DEMO_USAGE.md`](DEMO_USAGE.md) - Demo è„šæœ¬ä½¿ç”¨æŒ‡å—

---

## ğŸ“„ è®¸å¯è¯

MIT License
