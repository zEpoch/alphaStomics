# AlphaSTomics é…ç½®æ–‡ä»¶
# åŒæ¨¡æ€æ‰©æ•£æ¨¡å‹ï¼šè¡¨è¾¾é‡ + 3Dåæ ‡

# ==================== éšæœºç§å­è®¾ç½® ====================
# è®¾ç½®éšæœºç§å­ç¡®ä¿å®éªŒå¯å¤ç°
seed:
  value: 42                      # éšæœºç§å­å€¼
  deterministic: true            # æ˜¯å¦å¯ç”¨ç¡®å®šæ€§æ¨¡å¼ï¼ˆå¯èƒ½é™ä½æ€§èƒ½ï¼‰
  benchmark: false               # æ˜¯å¦å¯ç”¨ cuDNN benchmarkï¼ˆæå‡æ€§èƒ½ä½†é™ä½å¤ç°æ€§ï¼‰

# ==================== è®­ç»ƒæ¨¡å¼ ====================
# å¯é€‰: "expr_to_pos", "pos_to_expr", "joint"
training_mode: "joint"

# ==================== æ‰©æ•£æ¨¡å‹å‚æ•° ====================
diffusion:
  diffusion_steps: 1000
  diffusion_noise_schedule: "cosine"
  nu_expression: 1.0  # è¡¨è¾¾é‡çš„å™ªå£°è°ƒåº¦å‚æ•°
  nu_position: 1.0    # ä½ç½®çš„å™ªå£°è°ƒåº¦å‚æ•°

# ==================== æŸå¤±å‡½æ•°å‚æ•° ====================
loss:
  lambda_expression: 1.0      # è¡¨è¾¾é‡æŸå¤±æƒé‡
  lambda_position: 1.0        # ä½ç½®æŸå¤±æƒé‡
  use_distance_matrix: true   # æ˜¯å¦ä½¿ç”¨è·ç¦»çŸ©é˜µï¼ˆæ—‹è½¬ä¸å˜ï¼‰

# ==================== Masked Diffusion å‚æ•° ====================
# Masked Diffusion: å¯¹æ¯ä¸ªç»†èƒå†…éƒ¨çš„ç‰¹å¾ç»´åº¦è¿›è¡Œ masking
# å¢å¼ºæ¨¡å‹é²æ£’æ€§ï¼Œå­¦ä¹ ç‰¹å¾é—´ä¾èµ–å…³ç³»
masking:
  enable: false                      # æ˜¯å¦å¯ç”¨ Masked Diffusion
  expression_mask_ratio: 0.4         # è¡¨è¾¾é‡ mask æ¯”ä¾‹ (0.0-1.0)
  position_mask_ratio: 0.33          # åæ ‡ mask æ¯”ä¾‹ (0.0-1.0)
  mask_strategy: "random"            # mask ç­–ç•¥: "random", "block", "structured"
  mask_expression: true              # æ˜¯å¦ mask è¡¨è¾¾é‡
  mask_position: true                # æ˜¯å¦ mask åæ ‡
  reconstruction_weight: 0.5         # é‡å»ºæŸå¤±æƒé‡
  masking_probability: 0.5           # æ¯ä¸ª batch åº”ç”¨ masking çš„æ¦‚ç‡
  progressive_masking: false         # æ˜¯å¦æ¸è¿›å¼å¢åŠ  mask ratio
  progressive_steps: 10000           # æ¸è¿›å¼ masking çš„æ­¥æ•°

# ==================== è®­ç»ƒå‚æ•° ====================
training:
  learning_rate: 1e-4
  weight_decay: 1e-5
  batch_size: 32
  epochs: 100
  precision: "bf16-mixed"          # è®­ç»ƒç²¾åº¦: "32", "16-mixed", "bf16-mixed"
  gradient_clip_val: 1.0         # æ¢¯åº¦è£å‰ª
  accumulate_grad_batches: 1     # æ¢¯åº¦ç´¯ç§¯
  early_stopping: true           # æ˜¯å¦æ—©åœ
  patience: 10                   # æ—©åœè€å¿ƒå€¼
  scheduler:
    type: "cosine"
    T_max: 100
    eta_min: 1e-6

# ==================== åˆ†å¸ƒå¼è®­ç»ƒå‚æ•° ====================
distributed:
  enabled: false                  # æ˜¯å¦å¯ç”¨åˆ†å¸ƒå¼è®­ç»ƒ
  strategy: "ddp"                 # åˆ†å¸ƒå¼ç­–ç•¥: "ddp", "ddp_find_unused_parameters_true", "fsdp", "deepspeed"
  num_nodes: 1                    # èŠ‚ç‚¹æ•°é‡ï¼ˆæœºå™¨æ•°é‡ï¼‰
  devices: "auto"                 # GPU æ•°é‡: "auto", æ•´æ•°, æˆ–åˆ—è¡¨ [0, 1, 2]
  find_unused_parameters: false   # æ˜¯å¦æŸ¥æ‰¾æœªä½¿ç”¨çš„å‚æ•°ï¼ˆè°ƒè¯•ç”¨ï¼‰
  sync_batchnorm: true            # æ˜¯å¦åŒæ­¥ BatchNorm
  
  # DeepSpeed é…ç½®ï¼ˆä»…å½“ strategy="deepspeed" æ—¶ç”Ÿæ•ˆï¼‰
  deepspeed:
    stage: 2                      # ZeRO stage: 1, 2, 3
    offload_optimizer: false      # æ˜¯å¦å°†ä¼˜åŒ–å™¨å¸è½½åˆ° CPU
    offload_parameters: false     # æ˜¯å¦å°†å‚æ•°å¸è½½åˆ° CPU
  
  # FSDP é…ç½®ï¼ˆä»…å½“ strategy="fsdp" æ—¶ç”Ÿæ•ˆï¼‰
  fsdp:
    sharding_strategy: "FULL_SHARD"  # FULL_SHARD, SHARD_GRAD_OP, NO_SHARD
    cpu_offload: false

# ==================== æ¨¡å‹æ¶æ„å‚æ•° ====================

# è¡¨è¾¾é‡è¾“å…¥ MLP
mlp_in_expression_setting: 
  mlp_in_expression_dims: 128
  mlp_out_expression_dims: 256

# æ‰©æ•£æ—¶é—´è¾“å…¥ MLP
mlp_in_diffusion_time_setting:
  mlp_in_diffusion_time_dims: 64
  mlp_out_diffusion_time_dims: 64

# ä½ç½® MLP
PositionMLP_setting:
  hidden_dims: 64

# è¡¨è¾¾é‡è¾“å‡ºç»´åº¦
output_expression_dims: 256

# Transformer å±‚å‚æ•°
TransformerLayer_setting:
  num_layers: 6
  num_heads: 8
  dim_ff_expression: 1024
  dim_ff_diffusion_time: 256
  dropout: 0.1
  layer_norm_eps: 1e-6
  
  # ==================== Gated Attention å‚æ•° ====================
  # ğŸ†• æ–°å¢ï¼šé—¨æ§æ³¨æ„åŠ›æœºåˆ¶
  use_gated_attention: true       # æ˜¯å¦ä½¿ç”¨ Gated Attentionï¼ˆæ¨è trueï¼‰
  gate_type: "headwise"           # é—¨æ§ç±»å‹:
                                  #   - "headwise": æ¯ä¸ªå¤´ä¸€ä¸ªæ ‡é‡ gateï¼ˆæ¨èï¼Œå‚æ•°å°‘ï¼‰
                                  #   - "elementwise": æ¯ä¸ªå…ƒç´ ä¸€ä¸ª gateï¼ˆæ›´çµæ´»ï¼Œå‚æ•°å¤šï¼‰
                                  #   - "none": ä¸ä½¿ç”¨ gatingï¼ˆç­‰åŒäº use_gated_attention=falseï¼‰
  use_qk_norm: true               # æ˜¯å¦å¯¹ Q/K è¿›è¡Œ RMSNormï¼ˆæå‡è®­ç»ƒç¨³å®šæ€§ï¼‰
  
  # è¯´æ˜ï¼š
  # - Gated Attention å®Œå…¨æ›¿ä»£ Linear Attention
  # - ä½¿ç”¨æ ‡å‡† Softmax Attention (O(nÂ²))ï¼Œé€‚åˆ batch è®­ç»ƒ
  # - åŠ¨æ€è°ƒåˆ¶æ¯ä¸ªå¤´çš„è¾“å‡ºï¼Œå¢å¼ºåŒæ¨¡æ€å»ºæ¨¡èƒ½åŠ›
  # - é˜²æ­¢ attention sink ç°è±¡ï¼Œæå‡é•¿åºåˆ—æ³›åŒ–

# è¡¨è¾¾é‡è¾“å‡º MLP
mlp_out_expression_setting:
  hidden_dims: 512

# ä½ç½®èŒƒæ•°è¾“å‡º MLP
mlp_out_position_norm_setting:
  hidden_dims: 128

# ==================== æ•°æ®å‚æ•° ====================
data:
  # åŸå§‹æ•°æ®è·¯å¾„ï¼ˆåŒ…å« h5ad æ–‡ä»¶çš„ç›®å½•ï¼‰
  raw_data_dir: "./data/raw"
  # é¢„å¤„ç†åæ•°æ®è·¯å¾„
  processed_data_dir: "./data/processed"
  
  # é¢„å¤„ç†å‚æ•°
  preprocessing:
    gene_list_file: null          # å›ºå®šåŸºå› åˆ—è¡¨æ–‡ä»¶ï¼ˆæ¯è¡Œä¸€ä¸ªåŸºå› åï¼‰
    position_key: "ccf"           # AnnData.obsm ä¸­åæ ‡çš„ key
    position_is_3d: true          # åæ ‡æ˜¯å¦å·²ç»æ˜¯ 3Dï¼ˆCCF åæ ‡ç³»ï¼‰
    z_spacing: 1.0                # åˆ‡ç‰‡é—´çš„ z é—´è·ï¼ˆä»…å½“ position_is_3d=false æ—¶ä½¿ç”¨ï¼‰
    cell_type_key: "cell_type"    # ç»†èƒç±»å‹çš„ key
    scale: true                   # æ˜¯å¦è¿›è¡Œè¡¨è¾¾é‡ scale
    normalize_position: false     # æ˜¯å¦æ ‡å‡†åŒ–åæ ‡ï¼ˆfalse=ä¿æŒåŸå§‹CCFåæ ‡ï¼‰
  
  # æ•°æ®åŠ è½½å‚æ•°
  loading:
    mode: "slice"                 # è®­ç»ƒæ¨¡å¼: "slice"(åˆ‡ç‰‡çº§) æˆ– "cell"(ç»†èƒçº§)
    num_workers: 4                # æ•°æ®åŠ è½½çº¿ç¨‹æ•°
    train_ratio: 0.8              # è®­ç»ƒé›†æ¯”ä¾‹
    val_ratio: 0.1                # éªŒè¯é›†æ¯”ä¾‹
    expression_dropout: 0.1      # è¡¨è¾¾é‡ dropout æ¯”ä¾‹
    rotation: true               # æ˜¯å¦éšæœºæ—‹è½¬
  
  # æ•°æ®åˆ’åˆ†æ¯”ä¾‹
  split_ratio:
    train: 0.8
    val: 0.1
    test: 0.1

# ==================== é‡‡æ ·å‚æ•° ====================
sampling:
  num_steps: 100         # é‡‡æ ·æ­¥æ•°ï¼ˆå¯ä»¥å°äº diffusion_steps åŠ é€Ÿï¼‰
  mode: "joint"          # é‡‡æ ·æ¨¡å¼: "expr_to_pos", "pos_to_expr", "joint"

# ==================== æ—¥å¿—å’Œä¿å­˜ ====================
logging:
  logger: "tensorboard"          # æ—¥å¿—è®°å½•å™¨: "tensorboard", "wandb"
  wandb_project: "alphastomics"  # WandB é¡¹ç›®å
  log_every_n_steps: 10          # æ¯ N æ­¥è®°å½•ä¸€æ¬¡
  save_top_k: 3                  # ä¿å­˜æœ€å¥½çš„ K ä¸ªæ¨¡å‹
  save_dir: "./outputs"          # è¾“å‡ºç›®å½•

# ==================== è¯„ä¼°å‚æ•° ====================
evaluation:
  k_neighbors: 10                # kNN ç›¸å…³æŒ‡æ ‡ä½¿ç”¨çš„ k å€¼
  compute_spatial_metrics: true  # æ˜¯å¦è®¡ç®—ç©ºé—´æŒ‡æ ‡
